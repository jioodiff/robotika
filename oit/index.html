<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Face Recognition + Multi Face + Camera Selector</title>
<style>
:root{
  --bg:#0f1720;--panel:#0b1220;--text:#e6eef6;--accent:#22ff88;
}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,Segoe UI,Roboto,Arial;
  display:flex;flex-direction:column;align-items:center;
}
video,canvas{
  border:2px solid #333;border-radius:10px;margin-top:1rem;
}
select,button{
  background:var(--panel);color:var(--text);
  border:1px solid #333;border-radius:6px;padding:6px 10px;
  margin:4px;font-size:15px;
}
#status{margin-top:10px;font-weight:500}
</style>
</head>
<body>
<h2>Face Recognition + Wemos API (Multi Face)</h2>
<div>
  <label for="cameraSelect">Pilih Kamera:</label>
  <select id="cameraSelect"></select>
  <button id="btnStart">Start</button>
</div>
<video id="video" autoplay muted playsinline width="480" height="360"></video>
<canvas id="canvas" width="480" height="360"></canvas>
<div id="status">Status: Kamera belum aktif</div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<script>
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const cameraSelect=document.getElementById('cameraSelect');
const statusText=document.getElementById('status');
const wemosUrl="http://192.168.4.1/led"; // ubah sesuai IP Wemos-mu

let currentStream=null;
let labeledDescriptors=[];
let faceMatcher=null;
let detecting=false;

// =============== Inisialisasi ===============
Promise.all([
  faceapi.nets.tinyFaceDetector.loadFromUri('/models'),
  faceapi.nets.faceRecognitionNet.loadFromUri('/models'),
  faceapi.nets.faceLandmark68Net.loadFromUri('/models')
]).then(()=>{
  console.log("Model loaded");
});

// =================== Kamera ===================
async function listCameras(){
  const devices=await navigator.mediaDevices.enumerateDevices();
  const videoDevices=devices.filter(d=>d.kind==='videoinput');
  cameraSelect.innerHTML="";
  videoDevices.forEach((dev,i)=>{
    const opt=document.createElement('option');
    opt.value=dev.deviceId;
    opt.text=dev.label || `Kamera ${i+1}`;
    cameraSelect.appendChild(opt);
  });
  if(videoDevices.length===0){
    cameraSelect.innerHTML='<option>Tidak ada kamera</option>';
  }
}

async function startCamera(){
  detecting=false;
  if(currentStream){
    currentStream.getTracks().forEach(t=>t.stop());
  }
  const deviceId=cameraSelect.value;
  const constraints={video:{deviceId:deviceId?{exact:deviceId}:undefined}};
  try{
    currentStream=await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject=currentStream;
    statusText.textContent="Status: Kamera aktif";
    detecting=true;
    runDetection();
  }catch(e){
    statusText.textContent="Gagal mengakses kamera: "+e.message;
  }
}

document.getElementById('btnStart').onclick=startCamera;

// Minta izin kamera dulu biar enumerateDevices bisa dapet label
navigator.mediaDevices.getUserMedia({video:true}).then(stream=>{
  stream.getTracks().forEach(t=>t.stop());
  return listCameras();
}).catch(err=>{
  alert("Izin kamera ditolak atau tidak ada kamera: "+err.message);
});

// =================== Deteksi Wajah ===================
async function runDetection(){
  const displaySize={width:video.width,height:video.height};
  faceapi.matchDimensions(canvas,displaySize);
  while(detecting){
    const detections=await faceapi.detectAllFaces(video,new faceapi.TinyFaceDetectorOptions())
      .withFaceLandmarks().withFaceDescriptors();
    const resized=faceapi.resizeResults(detections,displaySize);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    let facesCount=resized.length;
    for(let i=0;i<facesCount;i++){
      const d=resized[i];
      let label="Unknown",color="#00aaff";
      if(faceMatcher){
        const best=faceMatcher.findBestMatch(d.descriptor);
        label=best.label;
        color=best.distance<0.45?"#00ff00":"#ff0000";
        if(best.distance<0.45)sendWemos(true);
        else sendWemos(false);
      }
      const box=d.detection.box;
      ctx.strokeStyle=color;
      ctx.lineWidth=2;
      ctx.strokeRect(box.x,box.y,box.width,box.height);
      ctx.fillStyle=color;
      ctx.fillText(label,box.x,box.y-5);
    }
    drawHUD(facesCount);
    await new Promise(r=>setTimeout(r,100));
  }
}

function drawHUD(count){
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,0.4)';
  ctx.fillRect(5,5,140,25);
  ctx.fillStyle='#fff';
  ctx.font='14px system-ui';
  ctx.fillText(`Faces: ${count}`,10,22);
  ctx.restore();
}

// =================== Wemos Control ===================
let ledTimeout=null;
function sendWemos(on){
  if(ledTimeout)return;
  fetch(`${wemosUrl}?led=${on?"on":"off"}`).catch(()=>{});
  ledTimeout=setTimeout(()=>{ledTimeout=null;},1000);
}
</script>
</body>
</html>
