<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Face Recognition with Camera Selector</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: "Segoe UI", system-ui;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    canvas {
      border-radius: 12px;
      margin-top: 10px;
      max-width: 100%;
    }
    select, button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      background: #222;
      color: #fff;
      margin: 6px;
      cursor: pointer;
    }
    button:hover, select:hover {
      background: #333;
    }
  </style>
</head>
<body>
  <h2>ðŸŽ¥ Face Recognition with Camera Selector</h2>

  <div>
    <label for="cameraSelect">Pilih Kamera:</label>
    <select id="cameraSelect"></select>
    <button id="startBtn">Mulai Kamera</button>
  </div>

  <video id="video" autoplay playsinline style="display:none;"></video>
  <canvas id="canvas"></canvas>

  <p id="status">Menunggu kamera...</p>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const cameraSelect = document.getElementById("cameraSelect");
    const statusText = document.getElementById("status");
    const startBtn = document.getElementById("startBtn");

    let stream = null;
    let detector = null;
    let recognizer = null;
    let faces = [];
    let lastDetected = "";
    let frameHold = 0;

    async function loadModels() {
      const files = [
        "https://rawcdn.githack.com/opencv/opencv/4.x/data/haarcascades/haarcascade_frontalface_default.xml"
      ];
      for (const file of files) {
        const name = file.split("/").pop();
        const response = await fetch(file);
        const data = await response.arrayBuffer();
        cv.FS_createDataFile("/", name, new Uint8Array(data), true, false);
      }
      detector = new cv.CascadeClassifier();
      detector.load("haarcascade_frontalface_default.xml");
      statusText.textContent = "âœ… Model wajah siap digunakan!";
    }

    async function getCameraList() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cameras = devices.filter(d => d.kind === "videoinput");
      cameraSelect.innerHTML = "";
      cameras.forEach((cam, i) => {
        const option = document.createElement("option");
        option.value = cam.deviceId;
        option.text = cam.label || `Kamera ${i + 1}`;
        cameraSelect.appendChild(option);
      });
      if (cameras.length === 0) {
        alert("Tidak ada kamera terdeteksi!");
      }
    }

    async function startCamera(deviceId) {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: deviceId ? { exact: deviceId } : undefined }
        });
        video.srcObject = stream;
        statusText.textContent = "ðŸŽ¥ Kamera aktif, mendeteksi wajah...";
        video.onloadedmetadata = () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          startDetection();
        };
      } catch (err) {
        alert("Gagal mengakses kamera: " + err.message);
      }
    }

    function startDetection() {
      const src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
      const gray = new cv.Mat();
      const facesMat = new cv.RectVector();

      function processFrame() {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        src.data.set(ctx.getImageData(0, 0, canvas.width, canvas.height).data);
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
        detector.detectMultiScale(gray, facesMat, 1.1, 4, 0);

        ctx.lineWidth = Math.max(2, Math.round(canvas.width / 200));

        if (facesMat.size() > 0) {
          for (let i = 0; i < facesMat.size(); i++) {
            const face = facesMat.get(i);
            const x = face.x, y = face.y, w = face.width, h = face.height;

            // Simulasi: setiap wajah akan dianggap "verified"
            const verified = true;
            const grad = ctx.createLinearGradient(x, y, x + w, y + h);
            grad.addColorStop(0, "#00ff99");
            grad.addColorStop(1, "#00cc66");
            ctx.strokeStyle = grad;
            ctx.shadowColor = "#00ff99";
            ctx.shadowBlur = 20;
            ctx.strokeRect(x, y, w, h);
            ctx.shadowBlur = 0;

            const label = verified ? "Wajah Dikenali âœ…" : "Unknown";
            ctx.font = "16px Segoe UI";
            ctx.fillStyle = "rgba(0,0,0,0.5)";
            const tw = ctx.measureText(label).width + 14;
            ctx.fillRect(x, y - 26, tw, 22);
            ctx.fillStyle = verified ? "#00ff99" : "#ffffff";
            ctx.fillText(label, x + 7, y - 10);
          }
        }

        requestAnimationFrame(processFrame);
      }

      requestAnimationFrame(processFrame);
    }

    // Inisialisasi
    startBtn.addEventListener("click", () => startCamera(cameraSelect.value));
    getCameraList();

    // Load OpenCV
    const script = document.createElement("script");
    script.src = "https://docs.opencv.org/4.x/opencv.js";
    script.onload = async () => {
      cv['onRuntimeInitialized'] = loadModels;
    };
    document.body.appendChild(script);
  </script>
</body>
</html>
