<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Face Recognition + Wemos Multi Face</title>
<style>
:root{--bg:#0f1720;--panel:#0b1220;--text:#e6eef6;--muted:#8fa4bf;--btn:#2b6cb0;--btn2:#334155;--border:#1b2b48}
*{box-sizing:border-box}
body{margin:16px;background:var(--bg);color:var(--text);font:14px/1.55 system-ui,Segoe UI,Roboto,Arial}
.card{max-width:1000px;margin:auto;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.5)}
#canvas{width:100%;max-width:1000px;border-radius:10px;background:#000;display:block}
#video{width:100%;max-width:1000px;border-radius:10px;margin:8px 0;display:none;opacity:.7}
button{padding:8px 12px;border:0;border-radius:10px;background:var(--btn);color:#fff;cursor:pointer}
button.secondary{background:var(--btn2)}
.muted{color:var(--muted)}
</style>
</head>
<body>
<div class="card">
<h2>Face Recognition + Wemos API (Multi Face)</h2>
<select id="camera"></select>
<button id="start" disabled>Start</button>
<button id="stop" class="secondary" disabled>Stop</button>
<label><input type="checkbox" id="showVideo"> tampilkan video</label>
<p class="muted" id="status">Status: memuat OpenCVâ€¦</p>
<video id="video" playsinline autoplay muted></video>
<canvas id="canvas" width="640" height="480"></canvas>
</div>

<script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady()"></script>
<script>
const $=id=>document.getElementById(id);
const camSel=$("camera"),btnS=$("start"),btnT=$("stop"),showVideoCb=$("showVideo");
const statusEl=$("status"),video=$("video"),canvas=$("canvas"),ctx=canvas.getContext('2d');
let stream=null,running=false,rafId=null;
let classifier=null,gray=null,rgba=null;
let detectEveryN=2,frameIndex=0,facesCount=0;
const cascadeURL='https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_frontalface_alt2.xml';
const DB_KEY='face_db_v1';const LBP_SIZE=100;
function loadDB(){try{return JSON.parse(localStorage.getItem(DB_KEY)||'{"labels":[]}');}catch{return {labels:[]};}}
function saveDB(db){localStorage.setItem(DB_KEY,JSON.stringify(db));}
function cosine(a,b){let dot=0,na=0,nb=0;for(let i=0;i<a.length;i++){dot+=a[i]*b[i];na+=a[i]*a[i];nb+=b[i]*b[i];}return dot/(Math.sqrt(na)*Math.sqrt(nb)+1e-9);}
function lbpHistFromBytes(bytes,w,h){const hist=new Float32Array(256);for(let y=1;y<h-1;y++){const yp=y*w;for(let x=1;x<w-1;x++){const c=bytes[yp+x];const code=((bytes[(y-1)*w+(x-1)]>=c)<<7)|((bytes[(y-1)*w+(x )]>=c)<<6)|((bytes[(y-1)*w+(x+1)]>=c)<<5)|((bytes[(y )*w+(x+1)]>=c)<<4)|((bytes[(y+1)*w+(x+1)]>=c)<<3)|((bytes[(y+1)*w+(x )]>=c)<<2)|((bytes[(y+1)*w+(x-1)]>=c)<<1)|((bytes[(y )*w+(x-1)]>=c)<<0);hist[code]+=1;}}let norm=0;for(let i=0;i<256;i++)norm+=hist[i]*hist[i];norm=Math.sqrt(norm)||1;for(let i=0;i<256;i++)hist[i]/=norm;return hist;}
function bestMatch(vec,db){if(!db.labels.length)return{name:"Unknown",score:0};let best={name:"Unknown",score:0};for(const r of db.labels){const s=cosine(vec,r.vec);if(s>best.score)best={name:r.name,score:s};}return best;}
function onOpenCvReady(){if(window.cv&&cv.getBuildInformation)initOpenCV();else if(window.cv)cv['onRuntimeInitialized']=initOpenCV;}
async function initOpenCV(){
 const res=await fetch(cascadeURL);const buf=new Uint8Array(await res.arrayBuffer());
 cv.FS_createDataFile('/','haarcascade.xml',buf,true,false,false);
 classifier=new cv.CascadeClassifier();classifier.load('haarcascade.xml');
 statusEl.textContent='Status: siap. Klik Start.';btnS.disabled=false;
 if(navigator.mediaDevices?.enumerateDevices)await fillCameraList();
}
async function fillCameraList(){
 const devices=await navigator.mediaDevices.enumerateDevices();
 const cams=devices.filter(d=>d.kind==='videoinput');
 camSel.innerHTML='';cams.forEach((d,i)=>{const o=document.createElement('option');o.value=d.deviceId;o.textContent=d.label||`Kamera ${i+1}`;camSel.appendChild(o);});
}
async function startCamera(){
 const devId=camSel.value||undefined;
 const c={video:devId?{deviceId:{exact:devId}}:true,audio:false};
 stream=await navigator.mediaDevices.getUserMedia(c);
 video.srcObject=stream;await video.play();await fillCameraList();
}
function stopCamera(){if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}video.srcObject=null;}

btnS.onclick=async()=>{await startCamera();running=true;btnS.disabled=true;btnT.disabled=false;video.style.display=showVideoCb.checked?'block':'none';startLoop();};
btnT.onclick=()=>{running=false;cancelAnimationFrame(rafId);stopCamera();btnS.disabled=false;btnT.disabled=true;statusEl.textContent='Stopped';};
showVideoCb.onchange=()=>{video.style.display=showVideoCb.checked?'block':'none';};

async function callLED(state){
 try{
  const base="http://192.168.1.11",key="rahasiaku123";
  await fetch(base+'/api/led',{method:'POST',headers:{'Content-Type':'application/json','X-API-Key':key},body:JSON.stringify({state})});
 }catch(e){console.warn(e);}
}
let lastTrigger=0;
async function triggerOnVerified(){const now=Date.now();if(now-lastTrigger<2000)return;lastTrigger=now;await callLED('on');setTimeout(()=>callLED('off'),5000);}

// === LOOP utama ===
function startLoop(){
 rgba&&rgba.delete();gray&&gray.delete();
 rgba=new cv.Mat(canvas.height,canvas.width,cv.CV_8UC4);gray=new cv.Mat();
 const faces=new cv.RectVector();
 const db=loadDB();const threshold=0.9;
 const step=()=>{
  if(!running){rgba.delete();gray.delete();faces.delete();return;}
  if(video.readyState>=2){
   ctx.drawImage(video,0,0,canvas.width,canvas.height);
   frameIndex++;
   if(frameIndex%detectEveryN===0){
    const data=ctx.getImageData(0,0,canvas.width,canvas.height);
    rgba.data.set(data.data);
    cv.cvtColor(rgba,gray,cv.COLOR_RGBA2GRAY);
    cv.equalizeHist(gray,gray);
    classifier.detectMultiScale(gray,faces,1.1,5,0,new cv.Size(60,60));
    facesCount=faces.size();
   }

   // ðŸ”½ Tambahan: Loop semua wajah (multi-face)
   for (let i = 0; i < faces.size(); i++) {
      const r = faces.get(i);

      const roi = gray.roi(r);
      const resized = new cv.Mat();
      cv.resize(roi, resized, new cv.Size(LBP_SIZE, LBP_SIZE), 0, 0, cv.INTER_AREA);

      const desc = lbpHistFromBytes(resized.data, resized.cols, resized.rows);
      const match = bestMatch(desc, db);
      const isVerified = match.score >= threshold;

      const label = isVerified ? `${match.name} (${match.score.toFixed(2)})` : `Unknown (${match.score.toFixed(2)})`;

      ctx.lineWidth = 2;
      ctx.strokeStyle = isVerified ? '#00ff66' : '#ff6666';
      ctx.strokeRect(r.x, r.y, r.width, r.height);
      ctx.fillStyle = 'rgba(0,0,0,0.5)';
      ctx.fillRect(r.x, r.y - 20, ctx.measureText(label).width + 10, 18);
      ctx.fillStyle = '#fff';
      ctx.fillText(label, r.x + 5, r.y - 7);

      // Trigger LED jika ada wajah terverifikasi
      if (isVerified && Date.now() - lastTrigger > 2000) {
        lastTrigger = Date.now();
        callLED('on');
        setTimeout(()=>callLED('off'),5000);
      }

      roi.delete();
      resized.delete();
   }
  }
  ctx.font='14px system-ui';ctx.fillStyle='#fff';ctx.fillText(`Faces: ${facesCount}`,10,20);
  rafId=requestAnimationFrame(step);
 };
 step();
}
</script>
</body>
</html>
